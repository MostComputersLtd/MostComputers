@using System.Collections.Generic;
@using MOSTComputers.Models.Product.Models;
@using MOSTComputers.UI.Web.RealWorkTesting.Models.Product;
@using MOSTComputers.UI.Web.RealWorkTesting.Pages.Shared.ProductPopups;

@model ProductImagesDisplayPopupPartialModel;

<div class="modal-header full-parent-width">

    @{
        string popupHeaderText = Model.ProductImagePopupUsageEnum switch
        {
            ProductImagePopupUsageEnum.ImagesInDatabase => "Stored images",
            ProductImagePopupUsageEnum.ImagesInFiles => "Images in files",
            ProductImagePopupUsageEnum.DisplayData => "Image Editor",
            _ => "Images"
        };
    }

    <h5 class="modal-title modal-title">@popupHeaderText:</h5>

    <h4 class="modal-title modal-product-name">@Model.ProductData.Name</h4>
    <h4 id="modal_title_productIdShow" class="modal-title modal-product-name">ID: @Model.ProductData.Id</h4>
    
    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" onclick="close_ProductImages_modal()">
    </button>
</div>
<div id="ProductImages_popup" class="modal-body full-parent-width bg-white overflow-y-auto">
    <div class="container d-flex flex-column border-2 full-parent-width full-parent-height">
        
        <ul id="productImageDisplay_ul"
            class="full-parent-width bg-white"
            onmousewheel="scrollHorizontally(event)"
            ondragover="productImageDisplay_ul_ondragover(event)">

            @if (Model.ImagesToDisplay is not null
            && Model.ImagesToDisplay.Count > 0)
            {
                string? firstModelHtmlData = Model.ImagesToDisplay.First().ProductImage?.HtmlData;

                for (int i = 0; i < Model.ImagesToDisplay.Count; i++)
                {
                    ProductImage? image = Model.ImagesToDisplay[i].ProductImage;
                    ProductImageFileNameInfo? imageFileNameInfo = Model.ImagesToDisplay[i].ProductImageFileNameInfo;

                    if (image is null || image.ImageData is null) continue;

                    string imageSrc = $"data:{image.ImageContentType};base64,{Convert.ToBase64String(image.ImageData)}";

                    float opacityOfLi = (imageFileNameInfo?.Active ?? false) ? 1.0F : 0.35F;

                    string htmlDataButtonBackgroundColor = (firstModelHtmlData == image.HtmlData) ? "#FFFFFF" : "#F7B9B9";

                    string imageDraggable = (Model.ProductImagePopupUsageEnum == ProductImagePopupUsageEnum.DisplayData) ? "true" : "false";

                    <li id="productImageDisplay_ul_li-@i" draggable="@imageDraggable"
                        ondragstart="productImageDisplay_ul_li_ondragstart(event)"
                        ondragend="productImageDisplay_ul_li_ondragend(event, @((int)Model.ProductImagePopupUsageEnum))"
                        style="opacity: @opacityOfLi;">
                        
                        @if (imageFileNameInfo?.Active ?? false)
                        {
                            <div class="product-image-popup-image-active-button-container">
                                <input id="productImageDisplay_ul_li_activityStatusCheckbox-@i"
                                    type="checkbox" aria-label="Close" checked
                                    onchange="update_productImageDisplay_ul_li_activeState('productImageDisplay_ul_li-@i',
                                        'productImageDisplay_ul_li_activityStatusCheckbox-@i',
                                        @Model.ProductData.Id,
                                        @imageFileNameInfo.DisplayOrder,
                                        '@imageFileNameInfo.FileName')"
                                    class="product-image-popup-image-active-button" />
                            </div>
                        }
                        else
                        {
                            <div class="product-image-popup-image-active-button-container">
                                <input id="productImageDisplay_ul_li_activityStatusCheckbox-@i"
                                    type="checkbox" aria-label="Close"
                                    onchange="update_productImageDisplay_ul_li_activeState('productImageDisplay_ul_li-@i',
                                        'productImageDisplay_ul_li_activityStatusCheckbox-@i',
                                        @Model.ProductData.Id,
                                        @imageFileNameInfo?.DisplayOrder,
                                        '@imageFileNameInfo?.FileName')"
                                    class="product-image-popup-image-active-button" />
                            </div>
                        }

                        <button name="Image #@i" class="btn bg-white" >
                            <img src="@imageSrc" title="Image #@i" draggable="false" />
                        </button>

                        @{string displayDeleteButton = (Model.ProductImagePopupUsageEnum == ProductImagePopupUsageEnum.ImagesInDatabase) ? "none" : "";}

                        <div class="product-image-popup-image-delete-button-container">
                            <button type="button" class="btn-close product-image-popup-image-delete-button"
                                aria-label="Close" style="display: @displayDeleteButton;"
                                onclick="delete_productImageDisplay_ul_li(
                                    @Model.ProductData.Id,
                                    @i,
                                    @((int)Model.ProductImagePopupUsageEnum),
                                    'productImageDisplay_ul_li-@i')" />
                        </div>

                        <div class="product-image-popup-image-date-modified-display-container">

                            @if (image.DateModified is not null)
                            {
                                <label class="align-text-center">
                                    @image.DateModified.Value.ToString("dd.MM.yyyy")
                                </label>
                            }
                            else
                            {
                                <label class="align-text-center">
                                    No date provided
                                </label>
                            }
                            
                            <button id="product-image-popup-image-view-html-button-@i"
                                style="background-color: @htmlDataButtonBackgroundColor;"
                                    onclick="displayImageHtmlData(
                                        'product-image-popup-view-html-display-div',
                                        '_hidden_product-image-popup-image-view-html_input-@i',
                                        'product-image-popup-view-raw-html-display_container')">
                                View Html
                            </button>
                        </div>

                        <input id="_hidden_product-image-popup-image-view-html_input-@i" type="hidden" value='@image.HtmlData' />
                        <input id="_hidden_product-image-popup-image-view-raw-html_input-@i" type="hidden" value='@(image.HtmlData)' />
                    </li>
                }
            }
            
            @if (Model.ProductImagePopupUsageEnum == ProductImagePopupUsageEnum.DisplayData)
            {
                <li id="addButtonLi"
                    class="product-image-popup-image-add-button-list-item">
                    <input class="btn bg-white product-image-popup-image-add-input"
                        type="file" accept="image/*"
                        onchange="addNewImage(this, @((int)Model.ProductImagePopupUsageEnum))" />

                    <label class="product-image-popup-image-add-label">+</label>
                </li>
            }
        </ul>

        <div id="product-image-popup-view-html-display-div" class="product-image-popup-view-html-display-div pb-4 mt-3"
             ondblclick="toggleHtmlDataAndRawHtmlData('_hidden_product-image-popup-image-view-html_input-',
                'product-image-popup-view-html-display-div',
                '_hidden_product-image-popup-image-view-raw-html_input-',
                'product-image-popup-view-raw-html-display_textarea',
                'product-image-popup-view-raw-html-display_container')"
             data-html-data-display-current-image-index="@(Model.ImagesToDisplay?.Count > 0 ? 0 : null)">
            @Html.Raw(Model.ImagesToDisplay?.FirstOrDefault()?.ProductImage?.HtmlData)
        </div>
        
        <div id="product-image-popup-view-raw-html-display_container"
            class="display-flex-not-important flex-column full-parent-width flex-grow-1 flex-shrink-0" style="display: none;">
            <textarea id="product-image-popup-view-raw-html-display_textarea"
                      class="full-parent-width flex-grow-1 flex-shrink-0 pb-0 overflow-y-auto"
                ondblclick="toggleHtmlDataAndRawHtmlData('_hidden_product-image-popup-image-view-html_input-',
                    'product-image-popup-view-html-display-div',
                    '_hidden_product-image-popup-image-view-raw-html_input-',
                    'product-image-popup-view-raw-html-display_textarea',
                    'product-image-popup-view-raw-html-display_container')"></textarea>

                <button id="product-image-popup-view-raw-html-save_button" type="button"
                    class="btn btn-secondary full-parent-width"
                    onclick="alterAllImagesHtmlData(@Model.ProductData.Id,
                        @((int)Model.ProductImagePopupUsageEnum),
                        'product-image-popup-view-raw-html-display_textarea',
                        '@Model.PopupContainerId')">
                    Save
                </button>
        </div>
    </div>
</div>

<div class="modal-footer full-parent-width product-image-popup-footer_buttons-container">
    <table id="ProductImages_modal_footer_buttons_table"
        class="full-parent-width full-parent-height product-image_modal_footer_buttons_table">
        <tr class="full-parent-width full-parent-height">
            <td>
                <button id="copyImageButton"
                    class="full-parent-width footer-button btn btn-primary"
                    onclick="copyImageDataToClipboard('@Model.NotificationBoxId')">
                    <h7 class="footer-button-main-text">Copy to clipboard</h7>
                    <p class="footer-button-small-text">(Or just press Ctrl + S)</p>
                </button>
            </td>
            
            <td>
                <button id="copyImageButton"
                    class="full-parent-width footer-button btn btn-primary"
                    onclick="getImageFileData(@Model.ProductData.Id, '@Model.NotificationBoxId')">
                    <h7 class="footer-button-main-text">Save</h7>
                    <p class="footer-button-small-text">(Or just press Ctrl + A)</p>
                </button>
            </td>
        </tr>
    </table>
</div>
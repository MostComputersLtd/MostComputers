@page "{ProductId}"
@using MOSTComputers.Models.Product.Models;
@using MOSTComputers.Services.SearchStringOrigin.Models;
@using MOSTComputers.UI.Web.Mapping;
@using MOSTComputers.UI.Web.Models;
@using MOSTComputers.UI.Web.StaticUtilities;

@model MOSTComputers.UI.Web.Pages.ProductPropertiesEditorModel
@{
}

@section Styles {
    <link rel="stylesheet" href="~/css/Pages/Shared/ProductDisplayPopupsCommon.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Pages/Shared/ProductDisplayXmlPopup.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Pages/Shared/ProductDisplayImagesPopup.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Pages/Shared/ProductSearchStringPopup.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/NotificationBox.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/CustomTextSelection.css" asp-append-version="true" />

    <link rel="stylesheet" href="~/css/Pages/ProductPropertiesEditor.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/TextSelection.js"></script>
    <script src="~/js/Pages/Shared/ProductXmlPopupControl.js"></script>
    <script src="~/js/Pages/Shared/ProductImagesPopupControl.js"></script>
    <script src="~/js/Pages/Shared/ProductSearchStringPopupControl.js"></script>
    <script src="~/js/NotificationBox.js"></script>
    <script src="~/js/StringManipulation/DecodeFromHtml.js"></script>
    <script src="~/js/Pages/ProductPropertiesEditor.js"></script>
}

<table class="full-parent-width" style="margin:10px 15px">
    <tr>
        <td>
            <h4 class="modal-title modal-product-name-xml-modal">@Model.Product.Name</h4>
        </td>
        <td>
            <h4 id="modal-title_productIdShow" class="modal-title modal-product-name-xml-modal product-properties-editor-product-id-label">ID: @Model.Product.Id</h4>
        </td>

        <td style="width:99%">
        </td>

        <td>
            <ul class="full-parent-width buttons-for-popups-list">
                <li class="button-for-popup-li" style="">
                    <button class="btn full-parent-height" onclick="showImagePopupData(@Model.ProductId)">
                        <img src="~/img/show_Images_ProductDisplay_icon.png" alt="Images" style="max-width: 60px; max-height: 60px;" />
                    </button>
                </li>
                <li class="button-for-popup-li" style="min-width: 80px;">
                    <button class="btn btn-secondary full-parent-height" onclick="showXmlPopupData(@Model.ProductId)">View XML</button>
                </li>
            </ul>
        </td>
    </tr>

    <tr>
        @{
            var searchStringParts = Model.GetSearchStringPartsAndDataAboutTheirOrigin();
        }

        @if (searchStringParts is not null)
        {
            <td>
                
                <ul id="searchStringPartAndOriginPopupDisplay_ul" style="display: flex; list-style: none; flex-wrap: nowrap; justify-content: center; align-items: center; padding: 0px; margin: 0px;">

                    @{int i = 0;}

                    @foreach (KeyValuePair<string, List<SearchStringPartOriginData>?> kvp in searchStringParts)
                    {
                        string searchStringPart = kvp.Key;

                        <li>
                            <table onmouseleave="removeSearchStringOriginDataSmallPopup(@i, '@JsEscapeStringUtils.JavascriptEncode(searchStringPart)')">
                                <tr>
                                    <td id="searchStringPart_h2#@i" name="searchStringPart_h2"
                                        onmouseover="showSearchStringOriginDataSmallPopup(@i)"
                                        onclick="displayPopupAndTransportToSearchStringOriginDisplay(@Model.ProductId, @i)" style="display: flex; margin: 0px 1px;">

                                        <h7 class="productSearchString-popup-searchStringPart-label">@searchStringPart</h7>
                                    </td>
                                </tr>

                                <tr>
                                    <td id="searchStringPartOrigin_li#@i" name="searchStringPartOrigin_li"
                                        style="display: inline; min-width: 100px; border: 1px solid #ed9e79; border-radius: 5%; position: absolute; visibility: hidden; background-color: #fffaed;">

                                        @if (kvp.Value?.Count == 1)
                                        {
                                            SearchStringPartOriginData searchStringPartOriginData = kvp.Value[0];

                                            <ul style="display:inline-flex; text-align:center; padding: 0px; width: 100%; margin-bottom: 8px;">
                                                <li style="display: inline-flex">
                                                    <button style="position: relative; left: 0px; top: 0px;" onclick="copySearchStringPartToClipboard('@searchStringPart')">
                                                        +
                                                    </button>

                                                </li>
                                                <li id="searchStringPartOrigin_searchStringPartDisplay#@i" name="searchStringPartOrigin_searchStringPartDisplay"
                                                style="display: inline-flex; flex-grow: 1; justify-content: center;">
                                                    <h4 style="margin: 0px;">@searchStringPart</h4>
                                                </li>
                                                <li style="display: inline;">
                                                    <h6 style="color:dimgray; height: 100%; margin: 0px 0px 0px 9px; padding-bottom: 1px; display: inline-flex; flex-direction: column; justify-content: flex-end;">
                                                        ID: @searchStringPartOriginData.Characteristic.Id
                                                    </h6>
                                                </li>
                                            </ul>

                                            <h5>@searchStringPartOriginData.Characteristic.Meaning</h5>
                                        }
                                        else if (kvp.Value?.Count > 1)
                                        {
                                            <ul style="display:inline-flex; text-align:center; padding: 0px; width: 100%; justify-content: center; margin-bottom: 8px;">
                                                <li id="searchStringPartOrigin_searchStringPartDisplay#@i" name="searchStringPartOrigin_searchStringPartDisplay"
                                                    style="display: inline;">
                                                    <h4 style="margin: 0px;">@searchStringPart</h4>
                                                </li>
                                                
                                                <li style="display: inline;">
                                                    <button onclick="searchStringPartOrigin_multipleOriginsShow(@i, '@JsEscapeStringUtils.JavascriptEncode(searchStringPart)')">@kvp.Value.Count possibilities ></button>

                                                    <ul id="searchStringPartOrigin_multipleOriginsDisplayList#@i"
                                                        style="display: flex; flex-direction: column; list-style: none; visibility: hidden; position: absolute; left: 0px; background-color: lightgreen; border: 2px solid black; border-radius: 4%; padding: 0px;">
                                                        @for (int j = 0; j < kvp.Value.Count; j++)
                                                        {
                                                            SearchStringPartOriginData searchStringPartOriginData = kvp.Value[j];

                                                            <li style="border-bottom: 1.5px solid darkgray;">

                                                                <ul style="display:inline-flex; text-align:center; padding: 0px; width: 100%; justify-content: center; margin-bottom: 8px;">
                                                                    <li style="display: inline;">
                                                                        <h4 name="searchStringPartOrigin_multipleOriginsDisplayList_nameLabel#@i" style="margin: 0px;">@searchStringPartOriginData.Characteristic.Name</h4>
                                                                    </li>
                                                                    <li style="display: inline;">
                                                                        <h6 style="color:dimgray; height: 100%; margin: 0px 0px 0px 9px; padding-bottom: 1px; display: inline-flex; flex-direction: column; justify-content: flex-end;">
                                                                            ID: @searchStringPartOriginData.Characteristic.Id
                                                                        </h6>
                                                                    </li>
                                                                </ul>

                                                                <h5 name="searchStringPartOrigin_multipleOriginsDisplayList_meaningLabel#@i">@searchStringPartOriginData.Characteristic.Meaning</h5>
                                                            </li>
                                                        }
                                                    </ul>
                                                </li>
                                            </ul>
                                        }
                                        else
                                        {
                                            <h4 id="searchStringPartOrigin_searchStringPartDisplay#@i" name="searchStringPartOrigin_searchStringPartDisplay"
                                                style="text-align: center;">
                                                @searchStringPart
                                            </h4>
                                            <h4>No information could be found.</h4>
                                        }
                                    </td>
                                </tr>
                            </table>
                        </li>

                        i++;
                    }
                </ul>
            </td>
        }

    </tr>
</table>

<table id="propertyDisplay_table" class="full-parent-width">

    <tbody id="propertyDisplay_table_tbody">
        @for (int i = 0; i < Model.ProductProperties.Count; i++)
        {
            ProductProperty productProperty = Model.ProductProperties[i];

            if (productProperty.ProductCharacteristicId is null
                || productProperty.ProductCharacteristicId == 0)
            {
                <tr id="propertytr#@i">
                    <td class="property-td-alignedOnTop propertyWithoutCharacteristicId-characteristic-select-td">
                        <select asp-items="Model.GetRemainingCharacteristics()"></select>
                    </td>

                    <td class="property-value-td">
                        <div id="productPropertyDisplay_AutoExpandTextareaWrapper_div#@i" class="full-parent-width full-parent-height">
                            <div id="productPropertyDisplay_Value_div#@i" name="productPropertyDisplay_Value_div"
                                class="element-collection-dataItem full-parent-width full-parent-height property-value-div"
                                contenteditable="true" spellcheck="false" onfocusout="updatePropertyInTable(@Model.ProductId, @i)">@productProperty.Value</div>
                        </div>
                    </td>

                    <td class="property-td-alignedOnTop property-characterisricId-td">
                        <label id="productPropertyDisplay_CharacteristicId_Data_label#@i" name="productPropertyDisplay_CharacteristicId_Data_label">ID: None</label>
                    </td>

                    <td class="property-td-alignedOnTop property-xmlPlacement-td">
                        <select id="productPropertyDisplay_XmlPlacement_select#@i" name="productPropertyDisplay_XmlPlacement_select" asp-items="@XmlPlacementEnumMapping.GetSelectListItemsFromXmlPlacementEnumWithOneSelected(productProperty.XmlPlacement)"></select>
                    </td>
                </tr>

                <tr>
                    <td colspan="3">
                        <p class="invalid-characteristic-name-text">The product characteristic "@productProperty.ProductCharacteristicId" does not exist, please select a characteristic from the ones above</p>
                    </td>
                </tr>
            }
            else
            {
                <tr id="propertytr#@i">
                    <td class="property-td-alignedOnTop property-characteristic-td">
                        <label>@productProperty.Characteristic</label>
                    </td>

                    <td class="property-value-td property-td-alignedOnTop">
                        <div id="productPropertyDisplay_AutoExpandTextareaWrapper_div#@i" class="full-parent-width full-parent-height">
                            <div id="productPropertyDisplay_Value_div#@i" name="productPropertyDisplay_Value_div"
                                class="element-collection-dataItem full-parent-width full-parent-height property-value-div"
                                contenteditable="true" spellcheck="false" onfocusout="updatePropertyInTable(@Model.ProductId, @i)">@productProperty.Value</div>
                        </div>
                    </td>

                    <td class="property-td-alignedOnTop property-characterisricId-td">
                        <label id="productPropertyDisplay_CharacteristicId_Data_label#@i" name="productPropertyDisplay_CharacteristicId_Data_label">ID: @productProperty.ProductCharacteristicId</label>
                    </td>

                    <td class="property-td-alignedOnTop property-xmlPlacement-td">
                        <select id="productPropertyDisplay_XmlPlacement_select#@i" name="productPropertyDisplay_XmlPlacement_select" asp-items="@XmlPlacementEnumMapping.GetSelectListItemsFromXmlPlacementEnumWithOneSelected(productProperty.XmlPlacement)"></select>
                    </td>

                    <td class="property-td-alignedOnTop property-delete-button-td">
                        <button id="productPropertyDisplay_Delete_button#@i" name="productPropertyDisplay_Delete_button"
                                class="btn btn-danger" onclick="deletePropertyInTable(@Model.ProductId, @productProperty.ProductCharacteristicId, @i, false)">
                            X
                        </button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<button class="btn btn-primary full-parent-width" onclick="addPropertyToTable(@Model.ProductId)">Add</button>

<div id="ProductXml_modal" class="modal fade" tabindex="-1" role="dialog">
    <div id="ProductXml-modal-dialog" class="modal-dialog modal-dialog-full-parent-width">
        <div id="ProductXml_popup_modal-content" class="modal-content full-parent-width full-parent-height modal-dialog-centered">
        </div>
    </div>
</div>

<div id="ProductImages_modal" class="modal fade" tabindex="-1" role="dialog">
    <div id="ProductImages-modal-dialog" class="modal-dialog modal-dialog-full-parent-width">
        <div id="ProductImages_popup_modal-content" class="modal-content full-parent-width full-parent-height modal-dialog-centered">
        </div>
    </div>
</div>

<div id="ProductSearchString_modal" class="modal fade" tabindex="-1" role="dialog">
    <div id="ProductSearchString-modal-dialog" class="modal-dialog modal-dialog-full-parent-width">
        <div id="ProductSearchString_popup_modal-content" class="modal-content full-parent-width full-parent-height modal-dialog-centered">
        </div>
    </div>
</div>

<ul id="copiedXmlNotificationBox" class="copied-xml-notification-box"></ul>

@Html.AntiForgeryToken()

<script>

    document.onkeydown = (e) =>
    {
        if (e.ctrlKey && e.key === 's')
        {
            let xmlTextArea = document.getElementById("Xml_textarea");

            if (xmlTextArea != null)
            {
                if (xmlTextArea.value != null)
                {
                    e.preventDefault();

                    copyXmlTextToClipboard();

                    return;
                }
            }

            let productImagesPopup = document.getElementById("ProductImages_popup");

            if (productImagesPopup === null) return;

            e.preventDefault();

            copyImageDataToClipboard();
        }
        else if (e.ctrlKey && e.key === 'a')
        {
            e.preventDefault();

            var productId = getProductId();

            getImageFileData(productId);
        }
    }

</script>